<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - SmartTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .sidebar a { color: #bdc3c7; text-decoration: none; padding: 10px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: white; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .risk-high { border-left: 5px solid #e74c3c; }
        .risk-low { border-left: 5px solid #2ecc71; }
        #preview { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar d-none d-md-block col-md-2">
        <h4 class="text-center py-4">SmartTrack</h4>
        <div class="text-center mb-4">
            <img id="sidebarProfileImg" src="https://via.placeholder.com/80" class="rounded-circle mb-2">
            <p id="studentName" class="mb-0 fw-bold">Loading...</p>
            <small id="studentId" class="text-muted">ID: ...</small>
        </div>
        <a href="#" class="active"><i class="fas fa-home me-2"></i> Dashboard</a>
        <a href="#schedule"><i class="fas fa-calendar-alt me-2"></i> Schedule</a>
        <a href="#" id="nav-enroll"><i class="fas fa-book-open me-2"></i> Enroll Course</a>
        <a href="#history"><i class="fas fa-history me-2"></i> History</a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-10 p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Dashboard</h3>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#qrModal">
                    <i class="fas fa-qrcode me-2"></i> Scan QR
                </button>
                <button class="btn btn-light position-relative">
                    <i class="fas fa-bell"></i>
                    <span id="notifCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none">0</span>
                </button>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Attendance</small>
                    <h2 id="attendancePct">--%</h2>
                    <div class="progress" style="height: 5px;">
                        <div id="attendanceBar" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Classes Attended</small>
                    <h2 id="attendedCount">--</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Missed</small>
                    <h2 id="missedCount" class="text-danger">--</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3 bg-primary text-white">
                    <small>Next Class</small>
                    <h5 id="nextClass" class="mt-1 mb-0">Loading...</h5>
                    <small id="nextClassTime">--:--</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- AI Insights -->
                <div class="card card-stat mb-4" id="aiCard">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-robot me-2 text-primary"></i>AI Insights</h5>
                        <p id="aiMessage" class="card-text">Analyzing your attendance patterns...</p>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="card card-stat mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Today's Schedule</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="scheduleList">
                            <!-- Populated by JS -->
                            <li class="list-group-item text-center text-muted">No classes today</li>
                        </ul>
                    </div>
                </div>

                <!-- Attendance History -->
                <div class="card card-stat">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4">
                <!-- Chart -->
                <div class="card card-stat mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Overview</h5>
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="card card-stat">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Notifications</h5>
                    </div>
                    <div class="card-body" id="notificationList">
                                                <div class="alert alert-info py-2 mb-2"><small>Welcome to SmartTrack!</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enroll Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enroll in a Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="enrollForm">
                    <div class="mb-3">
                        <label class="form-label">Course / Unit</label>
                        <input id="enrollCourse" class="form-control" placeholder="e.g. Data Structures" required />
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" type="submit">Enroll</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Class QR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="reader" style="width: 100%"></div>
                <p id="scanStatus" class="mt-2 text-muted">Position QR code within the frame</p>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');

    if (!token) window.location.href = '../login.html';

    // --- 1. Fetch Dashboard Data ---
    async function loadDashboard() {
        try {
            const res = await fetch(`${API_URL}/student/dashboard`, {
                headers: { 'Authorization': token }
            });
            const data = await res.json();

            // Update Profile
            document.getElementById('studentName').innerText = data.user.name;
            document.getElementById('studentId').innerText = `ID: ${data.user.regNo || 'N/A'}`;
            document.getElementById('sidebarProfileImg').src = data.user.profileImage;

            // Notifications
            const notifList = document.getElementById('notificationList');
            notifList.innerHTML = '';
            const notifs = (data.user.notifications || []).slice().reverse();
            if (notifs.length === 0) {
                notifList.innerHTML = `<div class="alert alert-info py-2 mb-2"><small>No notifications</small></div>`;
                document.getElementById('notifCount').style.display = 'none';
            } else {
                document.getElementById('notifCount').style.display = '';
                document.getElementById('notifCount').innerText = notifs.filter(n => !n.read).length || notifs.length;
                notifs.forEach(n => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert ${n.read ? 'alert-secondary' : 'alert-warning'} py-2 mb-2`;
                    alertDiv.innerHTML = `<small><strong>${n.title}</strong>: ${n.message}</small>`;
                    notifList.appendChild(alertDiv);
                });
            }

            // Update Stats
            document.getElementById('attendancePct').innerText = `${data.stats.attendancePct}%`;
            document.getElementById('attendanceBar').style.width = `${data.stats.attendancePct}%`;
            document.getElementById('attendedCount').innerText = data.stats.attended;
            document.getElementById('missedCount').innerText = data.stats.missed;

            // Update AI Insights
            const aiCard = document.getElementById('aiCard');
            document.getElementById('aiMessage').innerText = data.aiInsights.message;
            if (data.aiInsights.riskLevel === 'High Risk') aiCard.classList.add('risk-high');
            else aiCard.classList.add('risk-low');

            // Update Schedule
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';
            if (data.schedule.length > 0) {
                // Set Next Class
                const next = data.schedule.find(c => new Date(c.startTime) > new Date());
                if (next) {
                    document.getElementById('nextClass').innerText = next.unit;
                    document.getElementById('nextClassTime').innerText = new Date(next.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else {
                    document.getElementById('nextClass').innerText = "Done";
                    document.getElementById('nextClassTime').innerText = "For today";
                }

                data.schedule.forEach(cls => {
                    const time = new Date(cls.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const statusBadge = cls.status === 'cancelled' 
                        ? '<span class="badge bg-danger">Cancelled</span>' 
                        : '<span class="badge bg-primary">Upcoming</span>';
                    
                    scheduleList.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${cls.unit}</strong> <br>
                                <small class="text-muted"><i class="fas fa-clock"></i> ${time} | Room: ${cls.room || 'TBA'}</small>
                            </div>
                            ${statusBadge}
                        </li>
                    `;
                });
            }

            // Update History
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = '';
            data.history.forEach(log => {
                historyTable.innerHTML += `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleDateString()}</td>
                        <td>${log.classId}</td> <!-- Ideally resolve class name -->
                        <td><span class="badge bg-${log.status === 'present' ? 'success' : 'danger'}">${log.status}</span></td>
                    </tr>
                `;
            });

            // Render Chart
            new Chart(document.getElementById('attendanceChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Attended', 'Missed'],
                    datasets: [{
                        data: [data.stats.attended, data.stats.missed],
                        backgroundColor: ['#2ecc71', '#e74c3c']
                    }]
                }
            });

        } catch (err) {
            console.error(err);
        }
    }

    // --- 2. QR Scanner Logic ---
    let html5QrcodeScanner;

    document.getElementById('qrModal').addEventListener('shown.bs.modal', () => {
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        );
    });

    document.getElementById('qrModal').addEventListener('hidden.bs.modal', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear());
        }
    });

    async function onScanSuccess(decodedText, decodedResult) {
        // Stop scanning
        html5QrcodeScanner.stop();
        
        // Send to backend for real marking
        try {
            const res = await fetch(`${API_URL}/attendance/mark`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ qrCode: decodedText })
            });

            if (res.status === 201) {
                const json = await res.json();
                Swal.fire({ icon: 'success', title: 'Checked In', text: json.message || 'Attendance recorded', timer: 1800 });
                bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();
                loadDashboard();
                return;
            }

            if (res.status === 409) {
                Swal.fire({ icon: 'info', title: 'Already Checked', text: 'You have already checked in for this session.' });
                return;
            }

            if (res.status === 410) {
                Swal.fire({ icon: 'error', title: 'Expired', text: 'This QR code has expired.' });
                return;
            }

            const errBody = await res.json().catch(() => ({}));
            Swal.fire({ icon: 'error', title: 'Error', text: errBody.error || 'Invalid QR Code' });
        } catch (err) {
            console.error(err);
            Swal.fire({ icon: 'error', title: 'Error', text: 'Network or server error' });
        }
    }

    function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // console.warn(`Code scan error = ${error}`);
    }

    // --- 3. Real-Time Notifications ---
    const socket = io('http://localhost:5000');
    
    socket.on('notifyStudents', (data) => {
        // Add to notification list
        const notifList = document.getElementById('notificationList');
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning py-2 mb-2';
        alertDiv.innerHTML = `<small><strong>${data.title || 'Update'}:</strong> ${data.message}</small>`;
        notifList.prepend(alertDiv);

        // Show Toast/Alert
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });
        Toast.fire({
            icon: 'info',
            title: data.message
        });
    });

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '../login.html';
    }

    // Initialize
    loadDashboard();

    // --- Enroll UI wiring ---
    const navEnroll = document.getElementById('nav-enroll');
    if (navEnroll) navEnroll.addEventListener('click', (e) => { e.preventDefault(); new bootstrap.Modal(document.getElementById('enrollModal')).show(); });

    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const course = document.getElementById('enrollCourse').value.trim();
        if (!course) return Swal.fire('Validation', 'Please enter a course', 'warning');

        try {
            const res = await fetch(`${API_URL}/student/enroll`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ course })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Enrolled', `You have been enrolled in ${course}`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('enrollModal')).hide();
                loadDashboard();
            } else {
                Swal.fire('Error', data.error || 'Enrollment failed', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network error', 'error');
        }
    });

</script>
</body>
</html>