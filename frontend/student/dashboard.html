<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - SmartTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .sidebar a { color: #bdc3c7; text-decoration: none; padding: 10px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: white; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .risk-high { border-left: 5px solid #e74c3c; }
        .risk-low { border-left: 5px solid #2ecc71; }
        #preview { width: 100%; border-radius: 10px; }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar d-none d-md-block col-md-2">
        <h4 class="text-center py-4">SmartTrack</h4>
        <div class="text-center mb-4">
            <img id="sidebarProfileImg" src="https://via.placeholder.com/80" class="rounded-circle mb-2">
            <p id="studentName" class="mb-0 fw-bold">Loading...</p>
            <small id="studentId" class="text-muted">ID: ...</small>
            <div class="mt-2">
                <button id="editProfileBtn" class="btn btn-sm btn-light">Edit Profile</button>
            </div>
        </div>
        <a href="#" class="active"><i class="fas fa-home me-2"></i> Dashboard</a>
        <a href="#schedule"><i class="fas fa-calendar-alt me-2"></i> Schedule</a>
        <a href="#" id="nav-enroll"><i class="fas fa-book-open me-2"></i> Enroll Course</a>
        <a href="#history"><i class="fas fa-history me-2"></i> History</a>
        <a href="report-issue.html"><i class="fas fa-bullhorn me-2"></i> Report Issue</a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-10 p-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Dashboard</h3>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#qrModal">
                    <i class="fas fa-qrcode me-2"></i> Scan QR
                </button>
                <button class="btn btn-light position-relative" onclick="document.getElementById('notificationList').scrollIntoView({behavior: 'smooth'})">
                    <i class="fas fa-bell"></i>
                    <span id="notifCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none">0</span>
                </button>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Attendance</small>
                    <h2 id="attendancePct">--%</h2>
                    <div class="progress" style="height: 5px;">
                        <div id="attendanceBar" class="progress-bar bg-success" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Classes Attended</small>
                    <h2 id="attendedCount">--</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Missed</small>
                    <h2 id="missedCount" class="text-danger">--</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3 bg-primary text-white">
                    <small>Next Class</small>
                    <h5 id="nextClass" class="mt-1 mb-0">Loading...</h5>
                    <small id="nextClassTime">--:--</small>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-md-8">
                <!-- AI Insights -->
                <div class="card card-stat mb-4" id="aiCard">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-robot me-2 text-primary"></i>AI Insights</h5>
                        <p id="aiMessage" class="card-text">Analyzing your attendance patterns...</p>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="card card-stat mb-4" id="schedule">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Today's Schedule</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="scheduleList">
                            <!-- Populated by JS -->
                            <li class="list-group-item text-center text-muted">No classes today</li>
                        </ul>
                    </div>
                </div>

                <!-- Available Classes -->
                <div class="card card-stat mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Available Classes</h5>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="availableClassesList">
                            <!-- Populated by JS -->
                            <li class="list-group-item text-center text-muted">No available classes</li>
                        </ul>
                    </div>
                </div>

                <!-- Attendance History -->
                <div class="card card-stat">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-md-4">
                <!-- Chart -->
                <div class="card card-stat mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Overview</h5>
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="card card-stat">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Notifications</h5>
                    </div>
                    <div class="card-body" id="notificationList">
                                                <div class="alert alert-info py-2 mb-2"><small>Welcome to SmartTrack!</small></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enroll Modal -->
<div class="modal fade" id="enrollModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enroll in a Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="enrollForm">
                    <div class="mb-3">
                        <label class="form-label">Course / Unit</label>
                        <input id="enrollCourse" class="form-control" placeholder="e.g. Data Structures" required />
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" type="submit">Enroll</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal (added) -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input id="profileName" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password (leave blank to keep)</label>
                        <input id="profilePassword" type="password" class="form-control" />
                    </div>
                    <div class="text-end">
                        <button class="btn btn-primary" type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Report Issue Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Report Class Issue</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label">Issue Type</label>
                        <select id="reportType" class="form-select" required>
                            <option value="missed_class">Lecturer Missed Class</option>
                            <option value="lecturer_late">Lecturer Late</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course / Unit</label>
                        <input id="reportCourse" class="form-control" placeholder="e.g. Data Structures" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea id="reportDesc" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-danger" type="submit">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan Class QR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="reader" style="width: 100%"></div>
                <p id="scanStatus" class="mt-2 text-muted">Position QR code within the frame</p>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="http://localhost:5000/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    let socket = null;
    try { if (typeof io !== 'undefined') socket = io('http://localhost:5000'); } catch(e) { console.warn('Socket.io not available', e); }

    if (!token) window.location.href = '../login.html';

    async function loadDashboard() {
        try {
            const res = await fetch(`${API_URL}/student/dashboard`, {
                headers: { 'Authorization': token }
            });
            const data = await res.json();

            // Update Profile
            // Defensive profile rendering
            const name = data.user && data.user.name ? data.user.name : 'Student';
            const reg = data.user && data.user.regNo ? data.user.regNo : 'N/A';
            const img = data.user && data.user.profileImage ? data.user.profileImage : 'https://via.placeholder.com/80';
            document.getElementById('studentName').innerText = name;
            document.getElementById('studentId').innerText = `ID: ${reg}`;
            const imgEl = document.getElementById('sidebarProfileImg');
            imgEl.src = img;
            imgEl.onerror = () => { imgEl.src = 'https://via.placeholder.com/80'; };

            // Notifications
            const notifList = document.getElementById('notificationList');
            notifList.innerHTML = '';
            const notifs = (data.user.notifications || []).slice().reverse();
            if (notifs.length === 0) {
                notifList.innerHTML = `<div class="alert alert-info py-2 mb-2"><small>No new notifications</small></div>`;
                document.getElementById('notifCount').style.display = 'none';
            } else {
                const unreadCount = notifs.filter(n => !n.read).length;
                document.getElementById('notifCount').style.display = unreadCount > 0 ? '' : 'none';
                document.getElementById('notifCount').innerText = unreadCount;
                notifs.forEach(n => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert ${n.read ? 'alert-secondary' : 'alert-warning'} py-2 mb-2`;
                    alertDiv.innerHTML = `<small><strong>${n.title}</strong>: ${n.message}</small>`;
                    notifList.appendChild(alertDiv);
                });
            }

            // Update Stats
            document.getElementById('attendancePct').innerText = `${data.stats.attendancePct}%`;
            document.getElementById('attendanceBar').style.width = `${data.stats.attendancePct}%`;
            document.getElementById('attendedCount').innerText = data.stats.attended;
            document.getElementById('missedCount').innerText = data.stats.missed;

            // Update AI Insights
            const aiCard = document.getElementById('aiCard');
            document.getElementById('aiMessage').innerText = data.aiInsights.message;
            if (data.aiInsights.riskLevel === 'High Risk') aiCard.classList.add('risk-high');
            else aiCard.classList.add('risk-low');

            // Update Schedule & Join Socket Rooms
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';
            const scheduleArr = Array.isArray(data.schedule) ? data.schedule : [];
            if (scheduleArr.length > 0) {
                // Set Next Class
                const next = scheduleArr.find(c => new Date(c.startTime) > new Date() && c.status === 'upcoming');
                if (next) {
                    document.getElementById('nextClass').innerText = next.unit;
                    document.getElementById('nextClassTime').innerText = new Date(next.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else {
                    document.getElementById('nextClass').innerText = "Done";
                    document.getElementById('nextClassTime').innerText = "For today";
                }

                // Join a socket room for each class to receive live updates
                if (socket) scheduleArr.forEach(cls => { try { socket.emit('joinClass', cls._id); } catch(e){} });

                scheduleArr.forEach(cls => {
                    const time = new Date(cls.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    let statusBadge = '';
                    switch(cls.status) {
                        case 'upcoming': statusBadge = '<span class="badge bg-primary">Upcoming</span>'; break;
                        case 'ongoing': statusBadge = `<span class="badge bg-success">Ongoing ${cls.lecturerLate ? ' (Late)' : ''}</span>`; break;
                        case 'cancelled': statusBadge = '<span class="badge bg-danger">Cancelled</span>'; break;
                        case 'completed': statusBadge = '<span class="badge bg-secondary">Completed</span>'; break;
                        default: statusBadge = `<span class="badge bg-light text-dark">${cls.status}</span>`;
                    }
                    scheduleList.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center" data-class-id="${cls._id}">
                            <div><strong>${cls.unit}</strong><br><small class="text-muted"><i class="fas fa-clock"></i> ${time} | Room: ${cls.room || 'TBA'}</small></div>
                            <span class="status-badge">${statusBadge}</span>
                        </li>`;
                });
            } else {
                 scheduleList.innerHTML = '<li class="list-group-item text-center text-muted">No classes scheduled today</li>';
            }

            // Update Available Classes â€” if backend didn't send availableClasses, fetch from /api/classes
            const availableClassesList = document.getElementById('availableClassesList');
            availableClassesList.innerHTML = '';
            const available = Array.isArray(data.availableClasses) ? data.availableClasses : null;
            if (available) {
                if (available.length === 0) availableClassesList.innerHTML = '<li class="list-group-item text-center text-muted">No available classes</li>';
                else available.forEach(cls => {
                    const date = new Date(cls.startTime).toLocaleDateString();
                    const time = new Date(cls.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    availableClassesList.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div><strong>${cls.unit}</strong><br><small class="text-muted"><i class="fas fa-calendar"></i> ${date} | <i class="fas fa-clock"></i> ${time} | Room: ${cls.room || 'TBA'} | Lecturer: ${cls.lecturer ? cls.lecturer.name : 'N/A'}</small></div>
                            <button class="btn btn-sm btn-outline-primary" onclick="quickEnroll('${cls.unit}')">Enroll</button>
                        </li>`;
                });
            } else {
                // fallback: fetch all classes and show upcoming
                try {
                    const resAll = await fetch(`${API_URL}/classes`, { headers: { 'Authorization': token } });
                    if (resAll.ok) {
                        const all = await resAll.json();
                        const upcoming = (all || []).filter(c => new Date(c.startTime) > new Date()).slice(0,10);
                        if (upcoming.length === 0) availableClassesList.innerHTML = '<li class="list-group-item text-center text-muted">No available classes</li>';
                        else upcoming.forEach(cls => {
                            const date = new Date(cls.startTime).toLocaleDateString();
                            const time = new Date(cls.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            availableClassesList.innerHTML += `
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div><strong>${cls.unit}</strong><br><small class="text-muted"><i class="fas fa-calendar"></i> ${date} | <i class="fas fa-clock"></i> ${time} | Room: ${cls.room || 'TBA'} | Lecturer: ${cls.lecturer ? cls.lecturer.name : 'N/A'}</small></div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="quickEnroll('${cls.unit}')">Enroll</button>
                                </li>`;
                        });
                    } else {
                        availableClassesList.innerHTML = '<li class="list-group-item text-center text-muted">No available classes</li>';
                    }
                } catch (e) {
                    console.error('Failed to fetch available classes', e);
                    availableClassesList.innerHTML = '<li class="list-group-item text-center text-muted">No available classes</li>';
                }
            }

            // Update History
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = '';
            data.history.forEach(log => {
                historyTable.innerHTML += `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleDateString()}</td>
                        <td>${log.classSession.unit}</td>
                        <td><span class="badge bg-${log.status === 'present' ? 'success' : (log.status === 'late' ? 'warning' : 'danger')}">${log.status}</span></td>
                    </tr>`;
            });

            // Render Chart
            new Chart(document.getElementById('attendanceChart'), {
                type: 'doughnut',
                data: { labels: ['Attended', 'Missed'], datasets: [{ data: [data.stats.attended, data.stats.missed], backgroundColor: ['#2ecc71', '#e74c3c'] }] }
            });

        } catch (err) {
            console.error(err);
        }
    }

    // --- QR Scanner Logic (no changes) ---
    let html5QrcodeScanner = null;
    let isScanningProcessing = false;

    document.getElementById('qrModal').addEventListener('shown.bs.modal', () => {
        if (html5QrcodeScanner) return;
        isScanningProcessing = false;
        document.getElementById('scanStatus').innerText = "Position QR code within the frame";
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, ()=>{})
        .catch(err => {
            console.error("Camera error:", err);
            let errMsg = "Camera failed: " + err;
            if (err.name === 'NotReadableError') errMsg = "Camera is in use by another app. Please close it.";
            if (err.name === 'NotAllowedError') errMsg = "Camera permission denied.";
            
            document.getElementById('reader').innerHTML = `<div class="alert alert-danger">${errMsg}</div>`;
            html5QrcodeScanner = null; // Reset so we can try again
        });
    });
    document.getElementById('qrModal').addEventListener('hidden.bs.modal', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }).catch(() => { html5QrcodeScanner = null; });
        }
    });
    async function onScanSuccess(decodedText) {
        if (isScanningProcessing) return;
        isScanningProcessing = true;
        
        try {
            const res = await fetch(`${API_URL}/attendance/mark`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ qrCode: decodedText })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire({ icon: 'success', title: 'Checked In!', timer: 1800 });
                bootstrap.Modal.getInstance(document.getElementById('qrModal')).hide();
                loadDashboard();
            } else {
                Swal.fire({ icon: 'error', title: 'Error', text: data.error || 'Failed to check in' });
                isScanningProcessing = false; // Allow retry
            }
        } catch (err) {
            Swal.fire({ icon: 'error', title: 'Network Error' });
            isScanningProcessing = false; // Allow retry
        }
    }

    // --- Real-Time Notifications (NEW) ---
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 4000, timerProgressBar: true });

    function updateClassStatus(classId, badgeHtml, toastIcon, toastTitle) {
        const classLi = document.querySelector(`[data-class-id="${classId}"]`);
        if (classLi) {
            classLi.querySelector('.status-badge').innerHTML = badgeHtml;
            Toast.fire({ icon: toastIcon, title: toastTitle });
        }
    }

    socket.on('classStarted', (data) => updateClassStatus(data.classId, '<span class="badge bg-success">Ongoing</span>', 'success', 'A class has started!'));
    socket.on('lecturerLate', (data) => updateClassStatus(data.classId, `<span class="badge bg-warning text-dark">Lecturer Late</span>`, 'warning', `${data.lecturerName} is running late.`));
    socket.on('classCancelled', (data) => updateClassStatus(data.classId, '<span class="badge bg-danger">Cancelled</span>', 'error', 'A class has been cancelled.'));
    socket.on('classEnded', (data) => updateClassStatus(data.classId, '<span class="badge bg-secondary">Completed</span>', 'info', 'A class has ended.'));

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '../login.html';
    }

    // Initialize
    loadDashboard();

    // --- Enroll UI wiring ---
    const navEnroll = document.getElementById('nav-enroll');
    if (navEnroll) navEnroll.addEventListener('click', (e) => { e.preventDefault(); new bootstrap.Modal(document.getElementById('enrollModal')).show(); });

    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const course = document.getElementById('enrollCourse').value.trim();
        if (!course) return Swal.fire('Validation', 'Please enter a course', 'warning');

        try {
            const res = await fetch(`${API_URL}/student/enroll`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ course })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Enrolled', `You have been enrolled in ${course}`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('enrollModal')).hide();
                loadDashboard();
            } else {
                Swal.fire('Error', data.error || 'Enrollment failed', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network error', 'error');
        }
    });

    // Quick Enroll from list
    async function quickEnroll(courseName) {
        try {
            const res = await fetch(`${API_URL}/student/enroll`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ course: courseName })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Enrolled', `You have been enrolled in ${courseName}`, 'success');
                loadDashboard();
            } else {
                Swal.fire('Error', data.error || 'Enrollment failed', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Network error', 'error');
        }
    }

    // Edit profile wiring
    const editBtn = document.getElementById('editProfileBtn');
    if (editBtn) {
        editBtn.addEventListener('click', async () => {
            // populate modal with current name
            try {
                const res = await fetch(`${API_URL}/student/dashboard`, { headers: { 'Authorization': token } });
                const data = await res.json();
                document.getElementById('profileName').value = data.user && data.user.name ? data.user.name : '';
                document.getElementById('profilePassword').value = '';
                new bootstrap.Modal(document.getElementById('editProfileModal')).show();
            } catch (err) {
                console.error('Failed to load profile for edit', err);
                Swal.fire('Error', 'Could not load profile', 'error');
            }
        });
    }

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('profileName').value.trim();
        const password = document.getElementById('profilePassword').value;
        try {
            const res = await fetch(`${API_URL}/student/profile`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ name, password })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Saved', 'Profile updated', 'success');
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                loadDashboard();
            } else {
                Swal.fire('Error', data.error || 'Update failed', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network error', 'error');
        }
    });

    // Report Form Handler
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const type = document.getElementById('reportType').value;
        const course = document.getElementById('reportCourse').value;
        const description = document.getElementById('reportDesc').value;

        try {
            const res = await fetch(`${API_URL}/student/report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ type, subject: course, description, priority: 'medium' })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Submitted', 'Your anonymous report has been sent to administrators.', 'success');
                bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
                document.getElementById('reportForm').reset();
            } else {
                Swal.fire('Error', data.error || 'Submission failed', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network error', 'error');
        }
    });
</script>
</body>
</html>