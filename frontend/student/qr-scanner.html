<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassTrack AI - Scan Attendance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        #qr-reader { width: 100%; max-width: 500px; margin: 0 auto; }
        .scanner-container { background: #f8f9fa; padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>ClassTrack AI - Scan Attendance</h4>
                </div>
                <div class="card-body">
                    <div class="scanner-container">
                        <div id="qr-reader"></div>
                        <div id="scan-result" class="mt-3"></div>
                    </div>
                    <div class="mt-3">
                        <button id="start-scan" class="btn btn-primary">Start Scanner</button>
                        <button id="stop-scan" class="btn btn-secondary" disabled>Stop Scanner</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let html5QrCode;
let isScanning = false;

function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Device fingerprint', 2, 2);
    
    return {
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        language: navigator.language,
        fingerprint: btoa(canvas.toDataURL()).substring(0, 16)
    };
}

async function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation not supported'));
            return;
        }
        
        navigator.geolocation.getCurrentPosition(
            position => resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
            }),
            error => reject(error),
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
        );
    });
}

async function processQRScan(qrToken) {
    try {
        const deviceData = generateDeviceFingerprint();
        const location = await getCurrentLocation();
        
        const response = await fetch('http://localhost:5000/api/attendance/scan', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                qrToken,
                deviceFingerprint: deviceData.fingerprint,
                location,
                userAgent: deviceData.userAgent,
                screenResolution: deviceData.screenResolution,
                timezone: deviceData.timezone,
                language: deviceData.language
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            Swal.fire({
                icon: 'success',
                title: 'Attendance Marked!',
                text: data.late ? 'Marked as Late' : 'Marked as Present',
                timer: 2000
            });
            stopScanner();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Scan Failed',
                text: data.error
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to process attendance'
        });
    }
}

function startScanner() {
    if (isScanning) return;
    
    html5QrCode = new Html5Qrcode("qr-reader");
    
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
            processQRScan(decodedText);
        },
        (errorMessage) => {
            // Ignore scan errors
        }
    ).then(() => {
        isScanning = true;
        document.getElementById('start-scan').disabled = true;
        document.getElementById('stop-scan').disabled = false;
    }).catch(err => {
        Swal.fire({
            icon: 'error',
            title: 'Camera Error',
            text: 'Unable to access camera. Please check permissions.'
        });
    });
}

function stopScanner() {
    if (!isScanning || !html5QrCode) return;
    
    html5QrCode.stop().then(() => {
        isScanning = false;
        document.getElementById('start-scan').disabled = false;
        document.getElementById('stop-scan').disabled = true;
    });
}

document.getElementById('start-scan').onclick = startScanner;
document.getElementById('stop-scan').onclick = stopScanner;

// Auto-start scanner on page load
window.onload = () => {
    if (!localStorage.getItem('token')) {
        window.location.href = '../login.html';
        return;
    }
    startScanner();
};
</script>
</body>
</html>