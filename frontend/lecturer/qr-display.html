<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassTrack AI - Live QR Display</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        .qr-display { text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px; }
        .qr-image { max-width: 400px; width: 100%; border: 3px solid #007bff; border-radius: 10px; }
        .timer { font-size: 2rem; font-weight: bold; color: #dc3545; }
        .status-badge { font-size: 1.2rem; }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>Live Attendance QR Code</h4>
                    <span id="status-badge" class="badge bg-secondary status-badge">Not Started</span>
                </div>
                <div class="card-body">
                    <div id="qr-display" class="qr-display">
                        <p class="text-muted">Click "Start Attendance" to begin</p>
                    </div>
                    <div class="text-center mt-3">
                        <div id="timer" class="timer mb-3" style="display: none;">30</div>
                        <button id="start-btn" class="btn btn-success btn-lg me-2">Start Attendance</button>
                        <button id="end-btn" class="btn btn-danger btn-lg" disabled>End Attendance</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Live Attendance</h5>
                </div>
                <div class="card-body">
                    <div id="attendance-count" class="text-center">
                        <h3 class="text-primary">0</h3>
                        <p>Students Present</p>
                    </div>
                    <div id="attendance-list" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let socket;
let qrTimer;
let countdown = 25;
let attendanceActive = false;
let currentClassId;

function initializeSocket() {
    socket = io('http://localhost:5000');
    
    socket.on('attendanceMarked', (data) => {
        updateAttendanceList(data);
    });
    
    socket.on('qrRefresh', (data) => {
        displayQR(data.qrImage);
        resetTimer();
    });
}

function displayQR(qrImage) {
    document.getElementById('qr-display').innerHTML = `
        <img src="${qrImage}" class="qr-image" alt="Attendance QR Code">
        <p class="mt-2 text-muted">Students scan this QR code to mark attendance</p>
    `;
}

function startTimer() {
    countdown = 25;
    document.getElementById('timer').style.display = 'block';
    
    qrTimer = setInterval(() => {
        document.getElementById('timer').textContent = countdown;
        countdown--;
        
        if (countdown < 0) {
            refreshQR();
        }
    }, 1000);
}

function resetTimer() {
    clearInterval(qrTimer);
    startTimer();
}

function stopTimer() {
    clearInterval(qrTimer);
    document.getElementById('timer').style.display = 'none';
}

async function startAttendance() {
    try {
        const position = await getCurrentLocation();
        
        const response = await fetch('http://localhost:5000/api/classes/start-attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                classSessionId: getClassSessionId(),
                location: {
                    latitude: position.latitude,
                    longitude: position.longitude,
                    radius: 50
                }
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentClassId = getClassSessionId();
            socket.emit('joinClass', currentClassId);
            
            displayQR(data.qrImage);
            startTimer();
            
            attendanceActive = true;
            document.getElementById('status-badge').textContent = 'Active';
            document.getElementById('status-badge').className = 'badge bg-success status-badge';
            document.getElementById('start-btn').disabled = true;
            document.getElementById('end-btn').disabled = false;
            
            Swal.fire({
                icon: 'success',
                title: 'Attendance Started',
                text: 'Students can now scan the QR code',
                timer: 2000
            });
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message
        });
    }
}

async function refreshQR() {
    if (!attendanceActive) return;
    
    try {
        const response = await fetch(`http://localhost:5000/api/classes/refresh-qr/${currentClassId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        const data = await response.json();
        if (response.ok) {
            displayQR(data.qrImage);
            resetTimer();
        }
    } catch (error) {
        console.error('QR refresh failed:', error);
    }
}

async function endAttendance() {
    try {
        const response = await fetch(`http://localhost:5000/api/classes/end-attendance/${currentClassId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            stopTimer();
            attendanceActive = false;
            
            document.getElementById('qr-display').innerHTML = '<p class="text-muted">Attendance Ended</p>';
            document.getElementById('status-badge').textContent = 'Ended';
            document.getElementById('status-badge').className = 'badge bg-secondary status-badge';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('end-btn').disabled = true;
            
            Swal.fire({
                icon: 'info',
                title: 'Attendance Ended',
                text: 'No more students can mark attendance',
                timer: 2000
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to end attendance'
        });
    }
}

function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000
        });
    });
}

function getClassSessionId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('classId') || 'demo-class-id';
}

function updateAttendanceList(data) {
    const count = document.querySelector('#attendance-count h3');
    const currentCount = parseInt(count.textContent) + 1;
    count.textContent = currentCount;
    
    const list = document.getElementById('attendance-list');
    const item = document.createElement('div');
    item.className = `alert ${data.late ? 'alert-warning' : 'alert-success'} py-1`;
    item.innerHTML = `<small>Student marked ${data.late ? 'late' : 'present'}</small>`;
    list.appendChild(item);
}

document.getElementById('start-btn').onclick = startAttendance;
document.getElementById('end-btn').onclick = endAttendance;

window.onload = () => {
    if (!localStorage.getItem('token')) {
        window.location.href = '../login.html';
        return;
    }
    initializeSocket();
};
</script>
</body>
</html>