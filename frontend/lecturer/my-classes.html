<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Classes - Embedded</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{padding:1rem;background:#f8fafc} table td, table th{vertical-align:middle}</style>
</head>
<body>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">My Classes</h4>
    <div>
      <button class="btn btn-sm btn-secondary" id="btn-close">Close</button>
      <button class="btn btn-sm btn-primary" id="btn-refresh">Refresh</button>
    </div>
  </div>

  <div id="alert"></div>

  <div class="table-responsive">
    <table class="table table-hover" id="classesTable">
      <thead>
        <tr><th>Date / Time</th><th>Unit</th><th>Course</th><th>Room</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');

    async function load() {
      try {
        const res = await fetch(`${API_URL}/classes`, { headers: { 'Authorization': token } });
        if (!res.ok) throw new Error('Server returned ' + res.status);
        const classes = await res.json();
        const tbody = document.querySelector('#classesTable tbody');
        tbody.innerHTML = classes.map(c => {
          const dt = c.startTime ? new Date(c.startTime) : null;
          const label = dt ? dt.toLocaleString() : 'TBA';
            const actions = `
              <button class="btn btn-sm btn-primary me-1" onclick="parent.showQrModal('${c._id}','${(c.unit||'').replace(/'/g,"\\'")}')">Show QR</button>
              <button class="btn btn-sm btn-danger" onclick="parent.deleteClass('${c._id}')">Delete</button>
            `;
            return `<tr data-id="${c._id}"><td>${label}</td><td>${c.unit||''}</td><td>${c.course||''}</td><td>${c.room||'TBA'}</td><td>${c.status||''}</td><td>${actions}</td></tr>`;
        }).join('');
      } catch (err) {
        document.getElementById('alert').innerHTML = `<div class="alert alert-warning">${err.message}</div>`;
      }
    }

    document.getElementById('btn-close').addEventListener('click', () => {
      if (parent && typeof parent.showDashboard === 'function') parent.showDashboard();
    });
    document.getElementById('btn-refresh').addEventListener('click', load);

    load();
  </script>
</body>
</html>
