<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard - SmartTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .sidebar { min-height: 100vh; background: #2c3e50; color: white; }
        .sidebar a { color: #bdc3c7; text-decoration: none; padding: 10px 20px; display: block; }
        .sidebar a:hover, .sidebar a.active { background: #34495e; color: white; }
        .card-stat { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .status-upcoming { border-left: 5px solid #3498db; }
        .status-ongoing { border-left: 5px solid #2ecc71; }
        .status-cancelled { border-left: 5px solid #e74c3c; }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar d-none d-md-block col-md-2">
        <h4 class="text-center py-4">SmartTrack</h4>
        <div class="text-center mb-4">
            <img id="profileImg" src="https://via.placeholder.com/80" class="rounded-circle mb-2" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'80\' height=\'80\'><rect width=\'100%\' height=\'100%\' fill=\'%238ca0b6\' /><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-size=\'14\' fill=\'white\'>No Img</text></svg>'">
            <p id="lecturerName" class="mb-0 fw-bold">Loading...</p>
            <small class="text-muted">Lecturer</small>
        </div>
        <a href="#" class="active" onclick="showDashboard()"><i class="fas fa-chalkboard-teacher me-2"></i> Dashboard</a>
        <a href="#" id="nav-myclasses"><i class="fas fa-calendar-check me-2"></i> My Classes</a>
        <a href="#" id="nav-reports"><i class="fas fa-chart-bar me-2"></i> Reports</a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <!-- Main Content -->
    <div class="col-12 col-md-10 p-4">
        <div id="alertArea"></div>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Lecturer Dashboard</h3>
            <div>
                <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addClassModal">
                    <i class="fas fa-plus me-1"></i> Add Class
                </button>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#scanRoomModal">
                    <i class="fas fa-qrcode me-2"></i> Scan Room QR (Check-In)
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Today's Classes</small>
                    <h2 id="totalClasses">--</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3">
                    <small class="text-muted">Avg Attendance</small>
                    <h2 id="avgAttendance">--%</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-stat p-3 bg-primary text-white">
                    <small>Next Class</small>
                    <h5 id="nextClass" class="mt-1 mb-0">Loading...</h5>
                    <div id="nextClassAction" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Schedule -->
        <div id="scheduleCard" class="card card-stat">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Today's Schedule</h5>
                <button class="btn btn-sm btn-primary" onclick="loadDashboard()"><i class="fas fa-sync"></i> Refresh</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Course / Unit</th>
                                <th>Room</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- My Classes View (hidden by default) -->
        <div id="view-myclasses" style="display:none;">
            <div class="card card-stat">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Classes</h5>
                    <button class="btn btn-sm btn-primary" onclick="loadMyClasses()"><i class="fas fa-sync"></i> Refresh</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Unit</th>
                                    <th>Course</th>
                                    <th>Room</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myClassesTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports View (hidden by default) -->
        <div id="view-reports" style="display:none;">
            <div class="card card-stat">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Attendance Reports</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Class</label>
                            <select id="reportClassFilter" class="form-select">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="reportStartDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">End Date</label>
                            <input type="date" id="reportEndDate" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary d-block" onclick="generateReport()">Generate Report</button>
                        </div>
                    </div>
                    <div id="reportSummary" class="row mb-4" style="display:none;">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 id="totalRecords">0</h3>
                                    <small>Total Records</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 id="presentCount">0</h3>
                                    <small>Present</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 id="lateCount">0</h3>
                                    <small>Late</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 id="avgRiskScore">0</h3>
                                    <small>Avg Risk Score</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Risk Score</th>
                                </tr>
                            </thead>
                            <tbody id="reportTable">
                                <tr><td colspan="5" class="text-center text-muted">Click "Generate Report" to view data</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Class Modal -->
<div class="modal fade" id="addClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClassForm">
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <input type="text" class="form-control" id="classCourse" placeholder="e.g. BSc Computer Science">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit</label>
                        <input type="text" class="form-control" id="classUnit" placeholder="e.g. Data Structures" required>
                    </div>
                    <div class="mb-3 row">
                        <div class="col">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="classDate" required>
                        </div>
                        <div class="col">
                            <label class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="classStartTime" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Room</label>
                        <input type="text" class="form-control" id="classRoom" placeholder="e.g. Room A12">
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Student QR Display Modal -->
<div class="modal fade" id="classQrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered text-center">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Attendance QR</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h3 id="qrClassName">Unit Name</h3>
                <p class="text-muted">Ask students to scan this code</p>
                <div id="qrcode" class="d-flex justify-content-center my-3"></div>
                <div class="alert alert-info">
                    Live Attendance: <strong id="liveCount">0</strong> students
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="endClass()">End Class</button>
            </div>
        </div>
    </div>
</div>

<!-- Room Scan Modal (Lecturer Check-In) -->
<div class="modal fade" id="scanRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Verify Room Presence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="reader" style="width: 100%"></div>
                <p class="mt-2">Scan the QR code posted in the classroom</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Load socket.io from backend explicitly (avoid relative path when using Live Server) -->
<script src="http://localhost:5000/socket.io/socket.io.js"></script>

<script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    // Guard socket initialization in case the script fails to load
    const socket = (typeof io !== 'undefined') ? io('http://localhost:5000') : { emit: () => {} };
    let currentClassId = null;
    let qrCodeObj = null;

    if (!token) window.location.href = '../login.html';

    // --- 1. Load Dashboard ---
    async function loadDashboard() {
        try {
            const res = await fetch(`${API_URL}/lecturer/dashboard`, {
                headers: { 'Authorization': token }
            });
            if (!res.ok) throw new Error(`Server returned ${res.status}`);
            const data = await res.json();

            // Check if user data exists (handle deleted accounts or stale tokens)
            if (!data.user) {
                localStorage.removeItem('token');
                window.location.href = '../login.html';
                return;
            }

            // Join socket rooms for each class
            if (socket) {
                data.schedule.forEach(cls => socket.emit('joinClass', cls._id));
            }
            
            document.getElementById('lecturerName').innerText = data.user.name;

            const tbody = document.getElementById('scheduleTable');
            tbody.innerHTML = data.schedule.map(cls => {
                const time = new Date(cls.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const unitSafe = (cls.unit || '').replace(/'/g, "\\'");
                
                let actions = '';
                let statusBadge = '';

                switch (cls.status) {
                    case 'upcoming':
                        statusBadge = '<span class="badge bg-primary">Upcoming</span>';
                        actions = `<button class="btn btn-sm btn-success" onclick="startClass('${cls._id}', '${unitSafe}')">Start Class</button>`;
                        break;
                    case 'ongoing':
                        statusBadge = `<span class="badge bg-success">Ongoing ${cls.lecturerLate ? '(Late)' : ''}</span>`;
                        actions = `<button class="btn btn-sm btn-info" onclick="startClass('${cls._id}', '${unitSafe}')">Show QR</button>`;
                        break;
                    case 'completed':
                        statusBadge = '<span class="badge bg-secondary">Completed</span>';
                        break;
                    case 'cancelled':
                        statusBadge = '<span class="badge bg-danger">Cancelled</span>';
                        break;
                    default:
                        statusBadge = `<span class="badge bg-light text-dark">${cls.status}</span>`;
                }

                return `
                    <tr data-id="${cls._id}">
                        <td>${time}</td>
                        <td><strong>${cls.unit}</strong></td>
                        <td>${cls.room || 'TBA'}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>`;
            }).join('');
        } catch (err) {
            console.error(err);
            document.getElementById('alertArea').innerHTML = `<div class="alert alert-danger">Failed to load dashboard: ${err.message}</div>`;
        }
    }

    // --- 2. Class Actions ---
    async function startClass(id, name) {
        try {
            const res = await fetch(`${API_URL}/lecturer/class/${id}/start`, {
                method: 'POST',
                headers: { 'Authorization': token, 'Content-Type': 'application/json' },
            });
            const data = await res.json();

            if (!res.ok) {
                // If class is already ongoing, the backend returns the existing QR payload
                if (res.status === 400 && data.error && data.error.includes('already')) {
                     const existingPayload = data.qrPayload || `${id}|${data.qrToken}`;
                     showQrModal(id, name, existingPayload);
                     return;
                }
                throw new Error(data.error || 'Failed to start class');
            }

            showQrModal(id, name, data.qrPayload);
            loadDashboard(); // Refresh schedule to show 'ongoing' status
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    }

    async function cancelClass(id) {
        if(!confirm('Are you sure?')) return;
        await fetch(`${API_URL}/lecturer/class/${id}/cancel`, {
            method: 'POST',
            headers: { 'Authorization': token }
        });
        loadDashboard();
    }

    async function deleteClass(id) {
        if(!confirm('Are you sure you want to delete this class?')) return;
        try {
                const res = await fetch(`${API_URL}/classes/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            });
            if (res.ok) {
                Swal.fire('Deleted', 'Class deleted successfully', 'success');
                loadDashboard();
                if (typeof loadMyClasses === 'function') loadMyClasses();
            } else {
                const data = await res.json();
                Swal.fire('Error', data.error || 'Failed to delete class', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network error', 'error');
        }
    }

    async function endClass(id) {
        const targetId = id || currentClassId;
        await fetch(`${API_URL}/lecturer/class/${targetId}/end`, {
            method: 'POST',
            headers: { 'Authorization': token }
        });
        bootstrap.Modal.getInstance(document.getElementById('classQrModal')).hide();
        loadDashboard();
    }

    // --- 3. QR Display Logic ---
    function showQrModal(id, name, qrPayload) {
        currentClassId = id;
        document.getElementById('qrClassName').innerText = name;
        
        const modal = new bootstrap.Modal(document.getElementById('classQrModal'));
        modal.show();

        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById("qrcode"), { text: qrPayload, width: 250, height: 250 });

        // Get initial count and then listen for real-time updates
        (async () => {
            const res = await fetch(`${API_URL}/lecturer/class/${id}/attendance`, { headers: { 'Authorization': token } });
            const data = await res.json();
            document.getElementById('liveCount').innerText = data.count;
        })();
    }

    // Real-time attendance counter
    if (socket) {
        socket.on('attendanceUpdated', (data) => {
            if (data.classId === currentClassId) {
                const countEl = document.getElementById('liveCount');
                let currentCount = parseInt(countEl.innerText) || 0;
                countEl.innerText = currentCount + 1;
            }
        });
    }

        // --- 4. Room Scanner (Lecturer Check-In) ---
    let html5QrcodeScanner = null;
    document.getElementById('scanRoomModal').addEventListener('shown.bs.modal', () => {
        if (html5QrcodeScanner) return; // Prevent duplicate init
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            (errorMessage) => { /* ignore frame errors */ }
        ).catch(err => {
            console.error("Camera start failed", err);
            let errMsg = "Camera failed: " + err;
            if (err.name === 'NotReadableError') errMsg = "Camera is in use by another app. Please close it.";
            if (err.name === 'NotAllowedError') errMsg = "Camera permission denied.";

            document.getElementById('reader').innerHTML = `<div class="alert alert-danger">${errMsg}</div>`;
            html5QrcodeScanner = null; // Reset so we can try again
        });
    });

    document.getElementById('scanRoomModal').addEventListener('hidden.bs.modal', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null;
            }).catch(err => {
                console.warn("Scanner stop error:", err);
                html5QrcodeScanner = null;
            });
        }
    });

    async function onScanSuccess(decodedText) {
        // Close modal immediately; cleanup happens in 'hidden.bs.modal' event
        bootstrap.Modal.getInstance(document.getElementById('scanRoomModal')).hide();
        Swal.fire({ icon: 'success', title: 'Room Verified', text: `Checked in at: ${decodedText}` });
    }

    function logout() {
        localStorage.removeItem('token');
        window.location.href = '../login.html';
    }

    loadDashboard();

    // --- 5. Create Class Form ---
    document.getElementById('addClassForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const course = document.getElementById('classCourse').value;
        const unit = document.getElementById('classUnit').value;
        const date = document.getElementById('classDate').value;
        const startTime = document.getElementById('classStartTime').value;
        const room = document.getElementById('classRoom').value;

        if (!unit || !date || !startTime) {
            return Swal.fire('Validation', 'Please provide unit, date and start time', 'warning');
        }

        try {
            const res = await fetch(`${API_URL}/classes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ course, unit, startDate: date, start_time: startTime, room })
            });
            const data = await res.json();
            if (res.ok) {
                Swal.fire('Success', 'Class created', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addClassModal')).hide();
                // clear form
                document.getElementById('addClassForm').reset();
                loadDashboard();
                    // refresh sidebar
                    if (typeof loadMyClasses === 'function') loadMyClasses();
            } else {
                Swal.fire('Error', data.error || 'Failed to create class', 'error');
            }
        } catch (err) {
            console.error(err);
            Swal.fire('Error', 'Network or server error', 'error');
        }
    });

    // --- My Classes loader and focus ---
    async function loadMyClasses() {
        try {
            const res = await fetch(`${API_URL}/lecturer/classes`, { headers: { 'Authorization': token } });
            if (!res.ok) throw new Error(`Server returned ${res.status}`);
            const classes = await res.json();

            // populate internal cache table (used when My Classes view opens)
            const tbody = document.getElementById('myClassesTable');
            if (tbody) {
                tbody.innerHTML = classes.map(c => {
                    const dt = c.startTime ? new Date(c.startTime) : null;
                    const label = dt ? dt.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'TBA';
                    const unitSafe = (c.unit||'').replace(/'/g,"\\'");
                    
                    let actions = `<button class="btn btn-sm btn-outline-info me-1" onclick="showQrModal('${c._id}','${unitSafe}')">QR</button>`;
                    if(c.status === 'upcoming') {
                        actions += `<button class="btn btn-sm btn-outline-danger" onclick="deleteClass('${c._id}')"><i class="fas fa-trash"></i></button>`;
                    }

                    return `
                        <tr data-id="${c._id}">
                            <td>${label}</td>
                            <td>${c.unit || ''}</td>
                            <td>${c.course || ''}</td>
                            <td>${c.room || 'TBA'}</td>
                            <td><span class="badge bg-${c.status === 'ongoing' ? 'success' : 'secondary'}">${c.status || 'upcoming'}</span></td>
                            <td>${actions}</td>
                        </tr>`;
                }).join('');
            }
        } catch (err) {
            console.error('Failed to load classes', err);
            const alertArea = document.getElementById('alertArea');
            if (alertArea) alertArea.innerHTML = `<div class="alert alert-warning">Could not load classes: ${err.message}</div>`;
        }
    }

    function focusClass(id, unit) {
        const row = document.querySelector(`#scheduleTable tr[data-id="${id}"]`);
        if (row) {
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            row.classList.add('table-primary');
            setTimeout(() => row.classList.remove('table-primary'), 2500);
            return;
        }
        // otherwise open My Classes view and highlight
        showMyClasses(id);
    }

    // Initial load cache
    if (token) loadMyClasses();

    // --- View toggles ---
    function showMyClasses(highlightId) {
        document.getElementById('scheduleCard').style.display = 'none';
        document.getElementById('view-myclasses').style.display = 'block';
        document.getElementById('view-reports').style.display = 'none';
        loadMyClasses();
    }

    function showDashboard() {
        document.getElementById('view-myclasses').style.display = 'none';
        document.getElementById('view-reports').style.display = 'none';
        document.getElementById('scheduleCard').style.display = 'block';
        loadDashboard();
    }

    function showReports() {
        document.getElementById('scheduleCard').style.display = 'none';
        document.getElementById('view-myclasses').style.display = 'none';
        document.getElementById('view-reports').style.display = 'block';
        loadReportFilters();
    }

    async function loadReportFilters() {
        try {
            const res = await fetch(`${API_URL}/lecturer/classes`, { headers: { 'Authorization': token } });
            const classes = await res.json();
            const select = document.getElementById('reportClassFilter');
            select.innerHTML = '<option value="">All Classes</option>' + 
                classes.map(c => `<option value="${c._id}">${c.unit} - ${c.course || ''}</option>`).join('');
        } catch (err) {
            console.error('Failed to load class filters:', err);
        }
    }

    async function generateReport() {
        try {
            const classId = document.getElementById('reportClassFilter').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const params = new URLSearchParams();
            if (classId) params.append('classId', classId);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            const res = await fetch(`${API_URL}/lecturer/reports/attendance?${params}`, {
                headers: { 'Authorization': token }
            });
            const data = await res.json();
            
            if (res.ok) {
                document.getElementById('totalRecords').textContent = data.summary.totalRecords;
                document.getElementById('presentCount').textContent = data.summary.presentCount;
                document.getElementById('lateCount').textContent = data.summary.lateCount;
                document.getElementById('avgRiskScore').textContent = Math.round(data.summary.averageRiskScore);
                document.getElementById('reportSummary').style.display = 'block';
                
                const tbody = document.getElementById('reportTable');
                tbody.innerHTML = data.records.map(r => `
                    <tr>
                        <td>${r.user?.name || 'Unknown'} (${r.user?.regNo || 'N/A'})</td>
                        <td>${r.classSession?.unit || 'N/A'}</td>
                        <td>${new Date(r.timestamp).toLocaleDateString()}</td>
                        <td><span class="badge bg-${r.status === 'present' ? 'success' : 'warning'}">${r.status}</span></td>
                        <td>${r.aiRiskScore || 0}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-muted">No records found</td></tr>';
            } else {
                Swal.fire('Error', data.error, 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Failed to generate report', 'error');
        }
    }

    // Attach UI event listeners
    const navMy = document.getElementById('nav-myclasses');
    if (navMy) navMy.addEventListener('click', e => { e.preventDefault(); showMyClasses(); });
    
    const navReports = document.getElementById('nav-reports');
    if (navReports) navReports.addEventListener('click', e => { e.preventDefault(); showReports(); });

    const backBtn = document.getElementById('btn-back-dashboard');
    if (backBtn) backBtn.addEventListener('click', e => { e.preventDefault(); showDashboard(); });

</script>
</body>
</html>